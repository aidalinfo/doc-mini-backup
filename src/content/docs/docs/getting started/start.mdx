---
title: DÃ©marrage
sidebar:
  order: 2
description: DÃ©marrage rapide avec mini backup.
---
import { Aside, LinkCard, CardGrid, FileTree } from '@astrojs/starlight/components';

Pour faciliter la comprÃ©hension de l'outil, nous avons dÃ©cidÃ© d'utiliser docker pour vous proposes une configuration simple et fonctionnelle.

## Installation

En prÃ©requis il faudra donc docker et docker-compose.

En premier nous allons tÃ©lÃ©charger le projet mini-backup-getting-started.

**Wget :**
```bash
wget https://github.com/aidalinfo/mini-backup-getting-started/archive/refs/heads/main.zip \
     -O mini-backup-getting-started.zip
```

**Curl :**
```bash
curl -L https://github.com/aidalinfo/mini-backup-getting-started/archive/refs/heads/main.zip \
     -o mini-backup-getting-started.zip
```

Ensuite, nous allons dÃ©compresser le fichier tÃ©lÃ©chargÃ©.

```bash
unzip mini-backup-getting-started.zip
cd mini-backup-getting-started-main
```

## Explication docker compose

En premier nous avons un conteneur minio qui va nous permettre de crÃ©er un bucket pour les sauvegardes.
Nous avons aussi un conteneur pour la crÃ©ation du bucket.

```yaml
    image: minio/minio
    container_name: minio
    restart: always
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: miniopassword
    volumes:
      - ./minio/data:/data
    command: server /data --console-address ":9001"
    
  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add minio http://minio:9000 minioadmin miniopassword;
      /usr/bin/mc rm -r --force minio/backup;
      /usr/bin/mc mb minio/backup;
      /usr/bin/mc policy download minio/backup;
      exit 0;
```

Ensuite le conteneur mini-backup, qui va contenir la CLI, le serveur et l'API.
AUTO_CONFIG va nous permettre de gÃ©nÃ©rÃ© automatiquement les fichier de configuration requis.

AES KEY est la clÃ© AES utilisÃ©e pour chiffrer les sauvegardes, vous pouvez en gÃ©nÃ©rer une avec la commande ```openssl rand -base64 32```

```yaml
  mini-backup:
    image: rg.fr-par.scw.cloud/open-mini-backup/mini-backup:latest
    container_name: mini-backup
    restart: always
    volumes:
      - ./config:/app/config
    environment:
      - AUTO_CONFIG=true
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=miniopassword
      - GO_ENV=dev
      - AES_KEY=582e9ffb85124ee9b8cd572927ef671648e9dedd36f5352f755750930a2248d6
```

Pour la partie frontend et communication nous avons le conteneur de frontend et nginx.

```yaml
  ui-mini-backup:
    image: rg.fr-par.scw.cloud/open-mini-backup/ui-mini-backup:latest
    container_name: ui-mini-backup
    restart: always

  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - mini-backup
      - ui-mini-backup
```
<Aside type="caution" title="Communication">
    Aucune variable d'environment peut Ãªtre dÃ©finie pour le conteneur frontend.
    nginx nous sert Ã  exposer l'api de mini-backup sur localhost/api afin que le frontend puisse communiquer avec.
</Aside>

Enfin, pour rÃ©aliser nos tests, nous avons un conteneur mariadb et un conteneur mongo.

```yaml

  mariadb:
    image: mariadb
    container_name: mariadb
    restart: always
    volumes:
      - ./mariadb/data:/var/lib/mysql
    # ports:
    #   - "3306:3306"
    environment:
      - MARIADB_ROOT_PASSWORD=password
      - MARIADB_DATABASE=superdb
      - MARIADB_USER=user
      - MARIADB_PASSWORD=admin

  mongo:
    image: mongo
    restart: always
    container_name: mongo
    # ports:
      # - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
```

Maintenant nous allons faire un ```docker compose up``` pour lancer les conteneurs et gÃ©nÃ©rer les fichiers de configuration.

```bash
docker compose up -d
```

Deux fichier vont apparaÃ®tre dans le dossier config

```bash
âžœ  mini-backup-getting-started-main ls config
config.yaml server.yaml
```

Le fichier config.yaml va contenir la configuration de nos backups, les identifiants de connexion Ã  nos bases de donnÃ©es, chemin de sauvegarde, politique de rÃ©tention et cron.

Ici, nous allons Ã©diter le fichier server.yaml pour indiquer le nom du bucket S3 et les identifiants de connexion pour hÃ©berger nos sauvegardes.

Voici notre section rstorage aprÃ¨s modification :

```yaml
rstorage:
  minio:
    endpoint: "http://minio:9000"
    bucket_name: "backup"
    access_key: "${{MINIO_ACCESS_KEY}}"
    secret_key: "${{MINIO_SECRET_KEY}}"
    region: "fr-par"
```

Nous allons aussi dÃ©commenter la partie port de mongo, afin d'y accÃ©der avec mongo compass et y insÃ©rer des donnÃ©es.

<Aside>Vous pouvez aussi demander Ã  GPT un script pour mysql ou autre, l'objectif est de voir comment restaurer nos donnÃ©es.</Aside>

```yaml
    ports:
      - 27017:27017
```
## VÃ©rification

Une fois la modification effectuÃ©e, nous allons relancer le docker compose.

```bash
docker compose up -d && docker compose restart
```

Pour s'assurer que tout ce passe bien nous pouvons vÃ©rifier les logs du conteneur.

```bash
docker logs mini-backup
```

RÃ©sultat :

```
ðŸš€ DEV CONSOLE ðŸš€ -- Successfully compressed backups/mongo-20250122_222200.bson.gz
ðŸš€ DEV CONSOLE ðŸš€ -- [CORE_UTILS] Loading config file: config/server.yaml
ðŸš€ DEV CONSOLE ðŸš€ -- La section [minio] existe dÃ©jÃ  dans le fichier credentials. Aucune modification nÃ©cessaire.
ðŸš€ DEV CONSOLE ðŸš€ -- S3Manager initialized
ðŸš€ DEV CONSOLE ðŸš€ -- Fichier backups/mongo-20250122_222200.bson.gz.enc tÃ©lÃ©versÃ© avec succÃ¨s vers backup/mongo/mongo/mongo-20250122_222200.bson.gz.enc
ðŸš€ DEV CONSOLE ðŸš€ -- Successfully uploaded backups/mongo-20250122_222200.bson.gz.enc to backup
[backups/mongo-20250122_222200.bson.gz]
ðŸš€ DEV CONSOLE ðŸš€ -- Successfully backed up MongoDB for mongo: backups/mongo-20250122_222200.bson.gz
```

Maintenant nous allons crÃ©er une base et un document dans mongo.

![mongo compass](../../../../assets/SCR-20250122-ufbi.png)

Nous voyons que sur l'interface de minio, depuis la crÃ©ation du document, la taille du backup est un peu plus grande.

![minio](../../../../assets/SCR-20250122-uhba.png)

<Aside>L'interface de minio est accessible Ã  l'adresse http://localhost:9001</Aside>

**(Nous avons donc supprimer notre base de donnÃ©es pour tester la restauration)**

## Restauration

Pour restaurer nos donnÃ©es, nous avons par l'interface web ou la cli de mini-backup.

### Web

Rendez-vous sur http://localhost pour accÃ©der Ã  l'interface de mini-backup.

Sur la page d'accueil, nous avons notre liste des backups et nous pouvons cliquer sur l'icÃ´ne de restauration afin d'initier la procÃ©dure.

![restauration](../../../../assets/SCR-20250122-uiph.png)

Nous avons un encadrÃ© du backup qui sera restaurÃ©, nous pouvons cliquer sur le bouton de restauration pour rÃ©cupÃ©rer notre base prÃ©cÃ©demment supprimÃ©e.

![restauration](../../../../assets/SCR-20250122-ukgm.png)